{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <h2 class="mb-4">Список сохранённых материалов</h2>

    <!-- Фильтр по типу -->
    <form method="get" class="mb-3">
        <label for="type_filter" class="form-label">Тип материала:</label>
        <select name="type" id="type_filter" class="form-select" onchange="this.form.submit()">
            {% if 'gas' in available_types %}
                <option value="gas"{% if selected_type == 'gas' %} selected{% endif %}>Газы</option>
            {% endif %}
            {% if 'powder' in available_types %}
                <option value="powder"{% if selected_type == 'powder' %} selected{% endif %}>Порошки</option>
            {% endif %}
            {% if 'wire' in available_types %}
                <option value="wire"{% if selected_type == 'wire' %} selected{% endif %}>Проволока</option>
            {% endif %}
            {% if 'metal' in available_types %}
                <option value="metal"{% if selected_type == 'metal' %} selected{% endif %}>Металлы</option>
            {% endif %}
        </select>
    </form>

    {% if not gases and not powders and not wires and not metals %}
        <div class="alert alert-info" role="alert">
            Нет сохранённых материалов.
        </div>
    {% else %}
        <form method="post" action="{% url 'iacpaas:send_to_iacpaas' %}">
            {% csrf_token %}
            <div class="d-flex justify-content mb-3">
                <button type="submit" class="btn btn-primary">
                    Отправить в IACAPaaS
                </button>
            </div>

            <div class="row">
                <!-- Газы -->
                {% for gas in gases %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card shadow-sm collapsible-card">
                            <div class="card-header d-flex justify-content-between align-items-center collapsible-header" data-target="gas-details-{{ gas.id }}">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-chevron-down collapsible-icon me-2"></i>
                                    <h5 class="mb-0">{{ gas.name }}</h5>
                                </div>
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" name="selected_gases" value="{{ gas.id }}" id="gas_{{ gas.id }}" onclick="event.stopPropagation()">
                                    <label class="form-check-label" for="gas_{{ gas.id }}" onclick="event.stopPropagation()">Участвует</label>
                                </div>
                            </div>
                            <div class="card-body collapsible-content" id="gas-details-{{ gas.id }}" style="display: none;">
                                <p class="card-text">
                                    <strong>Формула:</strong> {{ gas.formula }}<br>
                                    <strong>Бренд:</strong> {{ gas.brand }}<br>
                                    <strong>Марка:</strong> {{ gas.grade }}<br>
                                    <strong>Стандарт:</strong> {{ gas.standards }}<br>
                                    <strong>Источник:</strong>
                                    <a href="{{ gas.adress }}" target="_blank" rel="noopener">{{ gas.adress }}</a>
                                </p>

                                <h6 class="mt-3">Химический состав:</h6>
                                {% if gas.chemicaldesignation_set.all %}
                                    <ul class="list-group list-group-flush">
                                        {% for cd in gas.chemicaldesignation_set.all %}
                                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                                {% if cd.percent_value == "?" or cd.percent_value == "-" or not cd.percent_value %}
                                                    <span style="color: red;">{{ cd.element.formula }}</span>
                                                {% elif cd.element.element_type == "compound_element" %}
                                                     <span style="color: darkgreen;">{{ cd.element.formula }}</span>
                                                {% elif not cd.element.in_iacpaas %}
                                                    <span style="color: orange;">{{ cd.element.formula }}</span>
                                                {% else %}
                                                    <span>{{ cd.element.formula }}</span>
                                                {% endif %}
                                                <span class="badge bg-secondary">{{ cd.percent_value }}%</span>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-muted"><em>Нет данных о составе</em></p>
                                {% endif %}
                            </div>
                            <div class="card-footer bg-light">
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteGas({{ gas.id }})">Удалить</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <!-- Порошки -->
                {% for powder in powders %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card shadow-sm collapsible-card">
                            <div class="card-header d-flex justify-content-between align-items-center collapsible-header" data-target="powder-details-{{ powder.id }}">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-chevron-down collapsible-icon me-2"></i>
                                    <h5 class="mb-0">{{ powder.powder_class.name }} - {{ powder.name }}</h5>
                                </div>
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" name="selected_powders" value="{{ powder.id }}" id="powder_{{ powder.id }}" onclick="event.stopPropagation()">
                                    <label class="form-check-label" for="powder_{{ powder.id }}" onclick="event.stopPropagation()">Участвует</label>
                                </div>
                            </div>
                            <div class="card-body collapsible-content" id="powder-details-{{ powder.id }}" style="display: none;">
                                <p class="card-text">
                                    <strong>Название:</strong> {{ powder.name }}<br>
                                    <strong>Класс:</strong> {{ powder.powder_class.name }}<br>
                                    <strong>Стандарт:</strong> {{ powder.standards }}<br>
                                    <strong>Источник:</strong>
                                    <a href="{{ powder.adress }}" target="_blank" rel="noopener">{{ powder.adress }}</a>
                                </p>

                                <!-- Форма и метод получения -->
                                <h6 class="mt-3">Форма и метод получения:</h6>
                                {% with pform=powder.particle_form_set.all %}
                                    {% if pform %}
                                        <ul class="list-group list-group-flush">
                                            {% for pf in pform %}
                                                {% if not pf.termin.in_iacpaas %}
                                                <li style="color: orange" class="list-group-item">
                                                {% else %}
                                                <li class="list-group-item">
                                                {% endif %}
                                                    {{ pf.termin.name }}: {{ pf.obtaining_method }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted"><em>Нет данных</em></p>
                                    {% endif %}
                                {% endwith %}

                                <!-- Свойства порошка -->
                                <h6 class="mt-3">Свойства:</h6>
                                {% with props=powder.powderpropertyvalue_set.all %}
                                    {% if props %}
                                        <ul class="list-group list-group-flush">
                                            {% for pp in props %}
                                                {% if pp.property_value == "-" or not pp.property_value %}
                                                    <li style="color: red;" class="list-group-item">
                                                {% elif not pp.property.in_iacpaas %}
                                                    <li style="color: orange;" class="list-group-item">
                                                {% else %}
                                                    <li class="list-group-item">
                                                {% endif %}
                                                    {{ pp.property.name }}: {{ pp.property_value }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted"><em>Нет свойств</em></p>
                                    {% endif %}
                                {% endwith %}

                                <!-- Элементный состав (ИСПРАВЛЕНО: было wire вместо powder) -->
                                <h6 class="mt-3">Элементный состав:</h6>
                                {% with comps=powder.elementalcomposition_powder_set.all %}
                                    {% if comps %}
                                        <ul class="list-group list-group-flush">
                                            {% for ec in comps %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    {% if ec.fraction == "-" or not ec.fraction %}
                                                        <span style="color: red;">{{ ec.element.formula }}</span>
                                                    {% elif ec.element.element_type == "compound_element" %}
                                                        <span style="color: darkgreen;">{{ ec.element.formula }}</span>
                                                    {% elif not ec.element.in_iacpaas %}
                                                        <span style="color: orange;">{{ ec.element.formula }}</span>
                                                    {% else %}
                                                        <span>{{ ec.element.formula }}</span>
                                                    {% endif %}
                                                    <span class="badge bg-info">{{ ec.fraction }}%</span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted"><em>Нет состава</em></p>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <div class="card-footer bg-light">
                                <button type="button" class="btn btn-danger btn-sm" onclick="deletePowder({{ powder.id }})">Удалить</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <!-- Проволока -->
                {% for wire in wires %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card shadow-sm collapsible-card">
                            <div class="card-header d-flex justify-content-between align-items-center collapsible-header" data-target="wire-details-{{ wire.id }}">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-chevron-down collapsible-icon me-2"></i>
                                    <h5 class="mb-0">{{ wire.wire_class.name }} - {{ wire.name }}</h5>
                                </div>
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" name="selected_wires" value="{{ wire.id }}" id="wire_{{ wire.id }}" onclick="event.stopPropagation()">
                                    <label class="form-check-label" for="wire_{{ wire.id }}" onclick="event.stopPropagation()">Участвует</label>
                                </div>
                            </div>
                            <div class="card-body collapsible-content" id="wire-details-{{ wire.id }}" style="display: none;">
                                <p class="card-text">
                                    <strong>Стандарт:</strong> {{ wire.standards }}<br>
                                    <strong>Источник:</strong>
                                    <a href="{{ wire.adress }}" target="_blank" rel="noopener">{{ wire.adress }}</a>
                                </p>

                                <!-- Диаметры -->
                                {% with diametrs=wire.metalwire_diametrs_set.all %}
                                    {% if diametrs %}
                                        <h6 class="mt-3">Диаметры:</h6>
                                        <ul class="list-group list-group-flush">
                                            {% for dia in diametrs %}
                                                {% if dia.value == "-" or not dia.value %}
                                                    <li style="color: red;" class="list-group-item">
                                                {% else %}
                                                    <li class="list-group-item">
                                                {% endif %}
                                                    {{ dia.value }} мм
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% endif %}
                                {% endwith %}

                                <!-- Свойства проволоки -->
                                <h6 class="mt-3">Свойства:</h6>
                                {% with props=wire.metalwirepropertyvalue_set.all %}
                                    {% if props %}
                                        <ul class="list-group list-group-flush">
                                            {% for mwp in props %}
                                                {% if mwp.value == "-" or not mwp.value %}
                                                    <li style="color: red;" class="list-group-item">
                                                {% elif not mwp.property.in_iacpaas %}
                                                    <li style="color: orange;" class="list-group-item">
                                                {% else %}
                                                    <li class="list-group-item">
                                                {% endif %}
                                                    {{ mwp.property.name }}: {{ mwp.value }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted"><em>Нет свойств</em></p>
                                    {% endif %}
                                {% endwith %}

                                <!-- Элементный состав -->
                                <h6 class="mt-3">Элементный состав:</h6>
                                {% with comps=wire.elementalcomposition_wire_set.all %}
                                    {% if comps %}
                                        <ul class="list-group list-group-flush">
                                            {% for ec in comps %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    {% if ec.fraction == "-" or not ec.fraction %}
                                                        <span style="color: red;">{{ ec.element.formula }}</span>
                                                    {% elif ec.element.element_type == "compound_element" %}
                                                        <span style="color: darkgreen;">{{ ec.element.formula }}</span>
                                                    {% elif not ec.element.in_iacpaas %}
                                                        <span style="color: orange;">{{ ec.element.formula }}</span>
                                                    {% else %}
                                                        <span>{{ ec.element.formula }}</span>
                                                    {% endif %}
                                                    <span class="badge bg-info">{{ ec.fraction }}%</span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted"><em>Нет состава</em></p>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <div class="card-footer bg-light">
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteWire({{ wire.id }})">Удалить</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}

                <!-- Металлы -->
                {% for metal in metals %}
                    <div class="col-md-6 col-lg-4 mb-4">
                        <div class="card shadow-sm collapsible-card">
                            <div class="card-header d-flex justify-content-between align-items-center collapsible-header" data-target="metal-details-{{ metal.id }}">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-chevron-down collapsible-icon me-2"></i>
                                    <h5 class="mb-0">{{ metal.metal_class.name }} - {{ metal.name }}</h5>
                                </div>
                                <div class="form-check mb-0">
                                    <input class="form-check-input" type="checkbox" name="selected_metals" value="{{ metal.id }}" id="metal_{{ metal.id }}" onclick="event.stopPropagation()">
                                    <label class="form-check-label" for="metal_{{ metal.id }}" onclick="event.stopPropagation()">Участвует</label>
                                </div>
                            </div>
                            <div class="card-body collapsible-content" id="metal-details-{{ metal.id }}" style="display: none;">
                                <p class="card-text">
                                    <strong>Стандарт:</strong> {{ metal.standards }}<br>
                                    <strong>Источник:</strong>
                                    <a href="{{ metal.adress }}" target="_blank" rel="noopener">{{ metal.adress }}</a>
                                </p>

                                <!-- Элементный состав -->
                                <h6 class="mt-3">Элементный состав:</h6>
                                {% with comps=metal.elementalcomposition_metal_set.all %}
                                    {% if comps %}
                                        <ul class="list-group list-group-flush">
                                            {% for ec in comps %}
                                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                                    {% if ec.fraction == "-" or not ec.fraction %}
                                                        <span style="color: red;">{{ ec.element.formula }}</span>
                                                    {% elif ec.element.element_type == "compound_element" %}
                                                        <span style="color: darkgreen;">{{ ec.element.formula }}</span>
                                                    {% elif not ec.element.in_iacpaas %}
                                                        <span style="color: orange;">{{ ec.element.formula }}</span>
                                                    {% else %}
                                                        <span>{{ ec.element.formula }}</span>
                                                    {% endif %}
                                                    <span class="badge bg-info">{{ ec.fraction }}%</span>
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted"><em>Нет состава</em></p>
                                    {% endif %}
                                {% endwith %}

                                <!-- Свойства металла -->
                                <h6 class="mt-3">Свойства:</h6>
                                {% with props=metal.metalpropertyvalue_set.all %}
                                    {% if props %}
                                        <ul class="list-group list-group-flush">
                                            {% for mp in props %}
                                                {% if mp.value == "-" or not mp.value %}
                                                    <li style="color: red;" class="list-group-item">
                                                {% elif not mp.property.in_iacpaas %}
                                                    <li style="color: orange;" class="list-group-item">
                                                {% else %}
                                                    <li class="list-group-item">
                                                {% endif %}
                                                    {{ mp.property.name }}: {{ mp.value }}
                                                </li>
                                            {% endfor %}
                                        </ul>
                                    {% else %}
                                        <p class="text-muted"><em>Нет свойств</em></p>
                                    {% endif %}
                                {% endwith %}
                            </div>
                            <div class="card-footer bg-light">
                                <button type="button" class="btn btn-danger btn-sm" onclick="deleteMetal({{ metal.id }})">Удалить</button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </form>
    {% endif %}
</div>

<!-- CSS для анимации -->
<style>
.collapsible-card {
    transition: all 0.3s ease;
    margin-bottom: 1rem;
}

.collapsible-card:hover {
    box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
}

.collapsible-header {
    cursor: pointer;
    background-color: #f8f9fa;
    transition: background-color 0.3s ease;
    padding: 0.75rem 1.25rem;
}

.collapsible-header:hover {
    background-color: #e9ecef;
}

.collapsible-icon {
    transition: transform 0.3s ease;
    font-size: 1.2rem;
    min-width: 24px;
    text-align: center;
}

.collapsible-header.collapsed .collapsible-icon {
    transform: rotate(-90deg);
}

.collapsible-content {
    transition: max-height 0.3s ease, opacity 0.3s ease;
    overflow: hidden;
    padding: 0 1.25rem;
}

.collapsible-content.show {
    display: block;
}

/* Стили для иконок (если не подключена Bootstrap Icons) */
.bi-chevron-down::before {
    content: "▼";
    font-size: 0.8em;
}
</style>

<!-- JavaScript для выдвижных карточек -->
<script>
// Функция для переключения состояния карточки
function toggleCardContent(targetId) {
    const content = document.getElementById(targetId);
    if (!content) return;

    const header = content.closest('.collapsible-card').querySelector('.collapsible-header');
    const icon = header.querySelector('.collapsible-icon');

    if (content.style.display === 'none' || content.style.display === '') {
        // Разворачиваем
        content.style.display = 'block';
        // Небольшая задержка для правильного расчета scrollHeight
        setTimeout(() => {
            content.style.maxHeight = content.scrollHeight + 'px';
            content.style.opacity = '1';
        }, 10);
        header.classList.remove('collapsed');
        icon.style.transform = 'rotate(0deg)';
    } else {
        // Сворачиваем
        content.style.maxHeight = '0px';
        content.style.opacity = '0';
        setTimeout(() => {
            content.style.display = 'none';
        }, 300);
        header.classList.add('collapsed');
        icon.style.transform = 'rotate(-90deg)';
    }
}

// Добавляем обработчики событий для всех заголовков
document.querySelectorAll('.collapsible-header').forEach(header => {
    header.addEventListener('click', function(e) {
        // Игнорируем клик, если он был на чекбоксе или лейбле
        if (e.target.closest('.form-check-input, .form-check-label')) {
            return;
        }
        const targetId = this.getAttribute('data-target');
        toggleCardContent(targetId);
    });
});

// Функции удаления остаются без изменений
function deleteGas(gasId) {
    if (!confirm('Удалить газ?')) return;
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url = `{% url 'iacpaas:delete_gas' 0 %}`.replace('/0/', '/' + gasId + '/');
    fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrf } })
        .then(r => r.ok ? document.querySelector(`[data-target="gas-details-${gasId}"]`)?.closest('.col-md-6')?.remove() : alert('Ошибка'))
        .catch(e => alert('Ошибка удаления'));
}

function deletePowder(powderId) {
    if (!confirm('Удалить порошок?')) return;
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url = `{% url 'iacpaas:delete_powder' 0 %}`.replace('/0/', '/' + powderId + '/');
    fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrf } })
        .then(r => r.ok ? document.querySelector(`[data-target="powder-details-${powderId}"]`)?.closest('.col-md-6')?.remove() : alert('Ошибка'))
        .catch(e => alert('Ошибка удаления'));
}

function deleteWire(wireId) {
    if (!confirm('Удалить проволоку?')) return;
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url = `{% url 'iacpaas:delete_wire' 0 %}`.replace('/0/', '/' + wireId + '/');
    fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrf } })
        .then(r => r.ok ? document.querySelector(`[data-target="wire-details-${wireId}"]`)?.closest('.col-md-6')?.remove() : alert('Ошибка'))
        .catch(e => alert('Ошибка удаления'));
}

function deleteMetal(metalId) {
    if (!confirm('Удалить металл?')) return;
    const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const url = `{% url 'iacpaas:delete_metal' 0 %}`.replace('/0/', '/' + metalId + '/');
    fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrf } })
        .then(r => r.ok ? document.querySelector(`[data-target="metal-details-${metalId}"]`)?.closest('.col-md-6')?.remove() : alert('Ошибка'))
        .catch(e => alert('Ошибка удаления'));
}
</script>
{% endblock %}
